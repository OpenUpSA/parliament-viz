---
import Layout from "../layouts/Layout.astro";
import data from "../data/bill-tracker.json";
import "../style/bill-tracker.scss";

// Sort bills by year
data.sort((a, b) => {
  return a.year - b.year;
});

// Add last house to events based on previous house if not present
data.forEach((bill) => {
  bill.events.forEach((event, index) => {
    if (!event.house) {
      event.house = bill.events.slice(0, index).reduce((house, event) => {
        return event.house || house;
      }, null);
    }
  });
});

// Add days since last event
data.forEach((bill) => {
  bill.events.forEach((event, index) => {
    if (index > 0) {
      const previousEvent = bill.events[index - 1];
      event.daysSinceLastEvent = Math.round(
        (new Date(event.date) - new Date(previousEvent.date)) /
          (1000 * 60 * 60 * 24)
      );
    }
  });
});
---

<Layout title="Bill Tracker">
  <div>
    {
      data.map((bill, index) => (
        <div class={`bill event-count-${bill.events.length}`}>
          {bill.events.map((event, index) => (
            <a
              href={`https://pmg.org.za/bill/${bill.id}/`}
              target="_blank"
              style={{ width: `${event.daysSinceLastEvent}px` }}
              title={`(${event.house}) ${event.title}: ${event.date}`}
              class={`event event-house-${event.house} ${bill.events[index - 1]?.house != event.house ? "previous-not-same-house" : ""} ${bill.events[index + 1]?.house != event.house ? "next-not-same-house" : ""}`}
            />
          ))}
        </div>
      ))
    }
  </div>
</Layout>
